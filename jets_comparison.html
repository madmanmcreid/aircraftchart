
<!DOCTYPE html>
<meta charset="utf-8">
<title>Airbus And Boeing Passenger Aircraft Comparison</title>
<style>
  :root { --legend-w: 320px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
  .container { max-width: 1400px; margin: 0 auto; }
  #wrap { display: grid; grid-template-columns: minmax(0, 1fr) var(--legend-w); gap: 12px; align-items: start; }
  #legends { position: sticky; top: 12px; }
  .panel { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  h2 { margin: 0 0 8px 0; }
  h3 { margin: 8px 0; font-size: 15px; }
  .legend-section { margin-bottom: 12px; }
  .legend-list { display: grid; grid-template-columns: 1fr; gap: 6px; max-height: 240px; overflow: auto; padding-right: 6px; }
  .legend-item { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 6px; border-radius: 6px; }
  .legend-item:hover { background: #f3f4f6; }
  .legend-item.active { outline: 2px solid #2563eb33; background: #eff6ff; }
  .swatch { width: 16px; height: 16px; border-radius: 9999px; border: 2px solid #111; background: none; }
  .swatch.dashed { border-style: dashed; }
  .swatch.solid { border-style: solid; }
  .swatch.color-airbus { border-color: #1f77b4; }
  .swatch.color-boeing { border-color: #d62728; }
  .swatch.engines::after { content: attr(data-eng); font-size: 10px; display: inline-block; transform: translate(1px,-1px); }
  .tip { position: absolute; pointer-events: none; padding: 6px 8px; background: white; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; box-shadow: 0 6px 16px rgba(0,0,0,.08); opacity: 0; }
  .controls { display:flex; gap:8px; align-items:center; margin:4px 0 6px; flex-wrap: wrap; }
  button { padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#f9fafb; cursor:pointer; }
  button:hover { background:#f3f4f6; }
  #chart { width: 100%; height: 680px; }
  .label { font-size: 10px; pointer-events: none; paint-order: stroke fill; stroke: rgba(255,255,255,0.9); stroke-width: 3px; }
</style>

<div class="container">
  <div id="wrap">
    <div id="vis" class="panel">
      <h2>Airbus And Boeing Passenger Aircraft Comparison</h2>
      <div class="controls">
        <button id="toggle-labels">Toggle labels</button>
        <button id="reset-zoom">Reset zoom</button>
        <button id="download-svg">Download SVG</button>
        <button id="download-png">Download PNG</button>
      </div>
      <svg id="chart" preserveAspectRatio="xMinYMin meet"></svg>
    </div>

    <div id="legends" class="panel">
      <h3>Highlight / Filter</h3>
      <div class="legend-section" id="legend-manufacturer">
        <h3>Manufacturer</h3>
        <div class="legend-list" id="list-manufacturer"></div>
      </div>
      <div class="legend-section" id="legend-bodytype">
        <h3>Body Type</h3>
        <div class="legend-list" id="list-bodytype"></div>
      </div>
      <div class="legend-section" id="legend-engines">
        <h3>Engines</h3>
        <div class="legend-list" id="list-engines"></div>
      </div>
      <div class="legend-section" id="legend-family">
        <h3>Family</h3>
        <div class="legend-list" id="list-family"></div>
      </div>
    </div>
  </div>
</div>

<div class="tip" id="tip"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = [{"Manufacturer": "Boeing", "Model": 720, "Max Range (km)": 5200, "Max Pax": 160, "Cabin Width (m)": 3.55, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 720"}, {"Manufacturer": "Boeing", "Model": "707-120", "Max Range (km)": 5600, "Max Pax": 174, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 707"}, {"Manufacturer": "Boeing", "Model": "707-120B", "Max Range (km)": 6700, "Max Pax": 174, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 707"}, {"Manufacturer": "Boeing", "Model": "707-320", "Max Range (km)": 6940, "Max Pax": 189, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 707"}, {"Manufacturer": "Boeing", "Model": "707-320B", "Max Range (km)": 9300, "Max Pax": 189, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 707"}, {"Manufacturer": "Boeing", "Model": "707-320C", "Max Range (km)": 5400, "Max Pax": 194, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 707"}, {"Manufacturer": "Boeing", "Model": "707-420", "Max Range (km)": 6940, "Max Pax": 189, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 4, "Family": "Boeing 707"}, {"Manufacturer": "Boeing", "Model": "717-200", "Max Range (km)": 2645, "Max Pax": 117, "Cabin Width (m)": 3.1, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 717"}, {"Manufacturer": "Boeing", "Model": "727-100", "Max Range (km)": 4170, "Max Pax": 125, "Cabin Width (m)": 3.5, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 727"}, {"Manufacturer": "Boeing", "Model": "727-200", "Max Range (km)": 3500, "Max Pax": 155, "Cabin Width (m)": 3.5, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 727"}, {"Manufacturer": "Boeing", "Model": "727-200 Advanced", "Max Range (km)": 4720, "Max Pax": 155, "Cabin Width (m)": 3.5, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 727"}, {"Manufacturer": "Boeing", "Model": "737 MAX 10", "Max Range (km)": 5700, "Max Pax": 230, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737 MAX 7", "Max Range (km)": 7000, "Max Pax": 172, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737 MAX 8", "Max Range (km)": 6500, "Max Pax": 210, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737 MAX 9", "Max Range (km)": 6100, "Max Pax": 220, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-100", "Max Range (km)": 2850, "Max Pax": 118, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-200", "Max Range (km)": 4800, "Max Pax": 136, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-300", "Max Range (km)": 4176, "Max Pax": 149, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-400", "Max Range (km)": 3820, "Max Pax": 188, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-500", "Max Range (km)": 4398, "Max Pax": 132, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-600", "Max Range (km)": 5991, "Max Pax": 130, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-700", "Max Range (km)": 5570, "Max Pax": 149, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-800", "Max Range (km)": 5436, "Max Pax": 189, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-900", "Max Range (km)": 5150, "Max Pax": 189, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "737-900ER", "Max Range (km)": 5460, "Max Pax": 220, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 737"}, {"Manufacturer": "Boeing", "Model": "747-100", "Max Range (km)": 8560, "Max Pax": 550, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-400D", "Max Range (km)": 8560, "Max Pax": 840, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-400M", "Max Range (km)": 10600, "Max Pax": 524, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747SP", "Max Range (km)": 10800, "Max Pax": 400, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-300", "Max Range (km)": 11720, "Max Pax": 660, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-200B", "Max Range (km)": 12150, "Max Pax": 550, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-400", "Max Range (km)": 13490, "Max Pax": 660, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-400ER", "Max Range (km)": 14045, "Max Pax": 660, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "747-8I", "Max Range (km)": 14320, "Max Pax": 605, "Cabin Width (m)": 6.1, "Body Type": "Wide", "Engines": 4, "Family": "Boeing 747"}, {"Manufacturer": "Boeing", "Model": "757-200", "Max Range (km)": 7250, "Max Pax": 239, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 757"}, {"Manufacturer": "Boeing", "Model": "757-300", "Max Range (km)": 6295, "Max Pax": 295, "Cabin Width (m)": 3.54, "Body Type": "Narrow", "Engines": 2, "Family": "Boeing 757"}, {"Manufacturer": "Boeing", "Model": "767-200", "Max Range (km)": 7200, "Max Pax": 255, "Cabin Width (m)": 4.72, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 767"}, {"Manufacturer": "Boeing", "Model": "767-200ER", "Max Range (km)": 12200, "Max Pax": 255, "Cabin Width (m)": 4.72, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 767"}, {"Manufacturer": "Boeing", "Model": "767-300", "Max Range (km)": 7200, "Max Pax": 351, "Cabin Width (m)": 4.72, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 767"}, {"Manufacturer": "Boeing", "Model": "767-300ER", "Max Range (km)": 11070, "Max Pax": 351, "Cabin Width (m)": 4.72, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 767"}, {"Manufacturer": "Boeing", "Model": "767-400ER", "Max Range (km)": 10415, "Max Pax": 375, "Cabin Width (m)": 4.72, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 767"}, {"Manufacturer": "Boeing", "Model": "777-200", "Max Range (km)": 9700, "Max Pax": 440, "Cabin Width (m)": 5.86, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "777-200ER", "Max Range (km)": 13080, "Max Pax": 440, "Cabin Width (m)": 5.86, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "777-200LR", "Max Range (km)": 15843, "Max Pax": 440, "Cabin Width (m)": 5.86, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "777-300", "Max Range (km)": 11165, "Max Pax": 550, "Cabin Width (m)": 5.86, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "777-300ER", "Max Range (km)": 13649, "Max Pax": 550, "Cabin Width (m)": 5.86, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "777-8", "Max Range (km)": 16190, "Max Pax": 395, "Cabin Width (m)": 5.96, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "777-9", "Max Range (km)": 13500, "Max Pax": 426, "Cabin Width (m)": 5.96, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 777"}, {"Manufacturer": "Boeing", "Model": "787-10", "Max Range (km)": 11720, "Max Pax": 440, "Cabin Width (m)": 5.49, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 787"}, {"Manufacturer": "Boeing", "Model": "787-8", "Max Range (km)": 13530, "Max Pax": 381, "Cabin Width (m)": 5.49, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 787"}, {"Manufacturer": "Boeing", "Model": "787-9", "Max Range (km)": 14010, "Max Pax": 420, "Cabin Width (m)": 5.49, "Body Type": "Wide", "Engines": 2, "Family": "Boeing 787"}, {"Manufacturer": "Airbus", "Model": "A220-100", "Max Range (km)": 6700, "Max Pax": 135, "Cabin Width (m)": 3.28, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A220"}, {"Manufacturer": "Airbus", "Model": "A220-300", "Max Range (km)": 6300, "Max Pax": 160, "Cabin Width (m)": 3.28, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A220"}, {"Manufacturer": "Airbus", "Model": "A300-600R", "Max Range (km)": 7500, "Max Pax": 345, "Cabin Width (m)": 5.28, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A300"}, {"Manufacturer": "Airbus", "Model": "A300B4-200", "Max Range (km)": 5375, "Max Pax": 345, "Cabin Width (m)": 5.28, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A300"}, {"Manufacturer": "Airbus", "Model": "A310-200", "Max Range (km)": 6500, "Max Pax": 237, "Cabin Width (m)": 5.28, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A310"}, {"Manufacturer": "Airbus", "Model": "A310-300", "Max Range (km)": 9540, "Max Pax": 265, "Cabin Width (m)": 5.28, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A310"}, {"Manufacturer": "Airbus", "Model": "A318-100", "Max Range (km)": 5700, "Max Pax": 132, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A319-100", "Max Range (km)": 6700, "Max Pax": 160, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A319neo", "Max Range (km)": 7400, "Max Pax": 160, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A320-100", "Max Range (km)": 3334, "Max Pax": 180, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A320-200", "Max Range (km)": 4800, "Max Pax": 186, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A320neo", "Max Range (km)": 6500, "Max Pax": 194, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A321", "Max Range (km)": 5930, "Max Pax": 244, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A321LR", "Max Range (km)": 7410, "Max Pax": 244, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A321neo", "Max Range (km)": 6480, "Max Pax": 244, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A321XLR", "Max Range (km)": 8700, "Max Pax": 244, "Cabin Width (m)": 3.7, "Body Type": "Narrow", "Engines": 2, "Family": "Airbus A320"}, {"Manufacturer": "Airbus", "Model": "A330-200", "Max Range (km)": 13450, "Max Pax": 406, "Cabin Width (m)": 5.26, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A330"}, {"Manufacturer": "Airbus", "Model": "A330-300", "Max Range (km)": 7400, "Max Pax": 440, "Cabin Width (m)": 5.26, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A330"}, {"Manufacturer": "Airbus", "Model": "A330-800", "Max Range (km)": 15000, "Max Pax": 406, "Cabin Width (m)": 5.26, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A330"}, {"Manufacturer": "Airbus", "Model": "A330-900", "Max Range (km)": 13400, "Max Pax": 440, "Cabin Width (m)": 5.26, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A330"}, {"Manufacturer": "Airbus", "Model": "A340-200", "Max Range (km)": 13500, "Max Pax": 375, "Cabin Width (m)": 5.287, "Body Type": "Wide", "Engines": 4, "Family": "Airbus A340"}, {"Manufacturer": "Airbus", "Model": "A340-300", "Max Range (km)": 12408, "Max Pax": 440, "Cabin Width (m)": 5.287, "Body Type": "Wide", "Engines": 4, "Family": "Airbus A340"}, {"Manufacturer": "Airbus", "Model": "A340-500", "Max Range (km)": 16670, "Max Pax": 375, "Cabin Width (m)": 5.287, "Body Type": "Wide", "Engines": 4, "Family": "Airbus A340"}, {"Manufacturer": "Airbus", "Model": "A340-600", "Max Range (km)": 14450, "Max Pax": 475, "Cabin Width (m)": 5.287, "Body Type": "Wide", "Engines": 4, "Family": "Airbus A340"}, {"Manufacturer": "Airbus", "Model": "A350-1000", "Max Range (km)": 17000, "Max Pax": 480, "Cabin Width (m)": 5.61, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A350"}, {"Manufacturer": "Airbus", "Model": "A350-1000ULR?", "Max Range (km)": 19000, "Max Pax": 480, "Cabin Width (m)": 5.61, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A350"}, {"Manufacturer": "Airbus", "Model": "A350-900", "Max Range (km)": 15742, "Max Pax": 440, "Cabin Width (m)": 5.61, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A350"}, {"Manufacturer": "Airbus", "Model": "A350-900ULR", "Max Range (km)": 17964, "Max Pax": 440, "Cabin Width (m)": 5.61, "Body Type": "Wide", "Engines": 2, "Family": "Airbus A350"}, {"Manufacturer": "Airbus", "Model": "A380-800", "Max Range (km)": 14800, "Max Pax": 853, "Cabin Width (m)": 7.2, "Body Type": "Wide", "Engines": 4, "Family": "Airbus A380"}];
const longest = 20037;

const colorStroke = d3.scaleOrdinal().domain(["Airbus","Boeing"]).range(["#1f77b4","#d62728"]);
const colorLabel  = d3.scaleOrdinal().domain(["Airbus","Boeing"]).range(["#0e4e88","#a32020"]);

const svg = d3.select("#chart");
function size() { const r = svg.node().getBoundingClientRect(); return {width:r.width, height:r.height}; }

function build() {
  svg.selectAll("*").remove();
  const {width, height} = size();
  const margin = { top: 50, right: 40, bottom: 60, left: 70 };
  const innerWidth = width - margin.left - margin.right;
  const innerHeight = height - margin.top - margin.bottom;

  const root = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  root.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width", innerWidth).attr("height", innerHeight);

  const yMax = d3.max(data, d => d["Max Pax"]);
  const x = d3.scaleLinear().domain([0, longest]).range([0, innerWidth]);
  const y = d3.scaleLinear().domain([0, yMax * 1.06]).range([innerHeight, 0]).nice();
  const r = d3.scaleLinear().domain(d3.extent(data, d => d["Cabin Width (m)"])).range([4, 20]);

  const gx = root.append("g").attr("transform", "translate(0," + innerHeight + ")").call(d3.axisBottom(x));
  const gy = root.append("g").call(d3.axisLeft(y));

  root.append("text").attr("x", innerWidth/2).attr("y", innerHeight + 45).attr("text-anchor","middle").text("Range (km)");
  root.append("text").attr("x", -innerHeight/2).attr("y", -50).attr("transform","rotate(-90)").attr("text-anchor","middle").text("Max Passenger Capacity");
  root.append("text").attr("x", innerWidth/2).attr("y", innerHeight + 60).attr("text-anchor", "middle").attr("fill", "#555").style("font-size", "12px").text("Note: Marker diameter represents cabin width.");

  const plot = root.append("g").attr("clip-path","url(#clip)");

  // Great-circle line & label
  const gcx = x(longest);
  const greatCircleGroup = plot.append("g");
  greatCircleGroup.append("line").attr("x1",gcx).attr("x2",gcx).attr("y1",0).attr("y2",innerHeight).attr("stroke","#aaa").attr("stroke-width",1.5).attr("stroke-dasharray","3 4");
  greatCircleGroup.append("text").attr("transform", "translate(" + (gcx - 6) + "," + (innerHeight/2) + ") rotate(-90)").attr("text-anchor","middle").attr("fill","#999").text("Longest theoretical great-circle distance");

  // Tooltip
  const tip = d3.select("#tip");
  function showTip(event, d) {
    tip.style("opacity", 1).html("<strong>" + d.Manufacturer + "</strong> " + d.Model + "<br/>Range: " + d["Max Range (km)"] + " km<br/>Max pax: " + d["Max Pax"])
      .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
  }
  function hideTip() { tip.style("opacity", 0); }

  // Points
  const dots = plot.selectAll("circle.dot").data(data).join("circle")
    .attr("class","dot")
    .attr("cx", d => x(d["Max Range (km)"]))
    .attr("cy", d => y(d["Max Pax"]))
    .attr("r", d => r(d["Cabin Width (m)"]))
    .attr("fill","none")
    .attr("stroke", d => colorStroke(d["Manufacturer"]))
    .attr("stroke-width",2)
    .attr("stroke-dasharray", d => d["Body Type"] === "Wide" ? "0" : "4 4")
    .on("mousemove", showTip)
    .on("mouseout", hideTip);

  // Labels: centered INSIDE markers (no vertical offset), fixed 10px
  let labelsVisible = true;
  const labels = plot.selectAll("text.label").data(data).join("text")
    .attr("class","label")
    .attr("text-anchor","middle")
    .attr("dominant-baseline","middle")
    .attr("fill", d => colorLabel(d["Manufacturer"]))
    .text(d => d.Model);

  function position(zx, zy) {
    const useX = zx || x, useY = zy || y;
    labels
      .attr("x", d => useX(d["Max Range (km)"]))
      .attr("y", d => useY(d["Max Pax"]));
  }
  position();

  document.getElementById("toggle-labels").onclick = () => {
    labelsVisible = !labelsVisible;
    labels.style("display", labelsVisible ? null : "none");
  };

  // Zoom (plot-only)
  const zoom = d3.zoom().scaleExtent([0.8, 12]).translateExtent([[0,0],[innerWidth, innerHeight]]).extent([[0,0],[innerWidth, innerHeight]]).on("zoom", (event) => {
      const zx = event.transform.rescaleX(x);
      const zy = event.transform.rescaleY(y);
      gx.call(d3.axisBottom(zx));
      gy.call(d3.axisLeft(zy));
      dots.attr("cx", d => zx(d["Max Range (km)"])).attr("cy", d => zy(d["Max Pax"]));
      const ngcx = zx(longest);
      greatCircleGroup.select("line").attr("x1", ngcx).attr("x2", ngcx);
      greatCircleGroup.select("text").attr("transform", "translate(" + (ngcx - 6) + "," + (innerHeight/2) + ") rotate(-90)");
      position(zx, zy);
  });

  const zoomRect = plot.append("rect").attr("id","zoom-rect").attr("width", innerWidth).attr("height", innerHeight).style("fill","none").style("pointer-events","all").lower().call(zoom);
  document.getElementById("reset-zoom").onclick = () => { d3.select("#zoom-rect").call(zoom.transform, d3.zoomIdentity); position(); };

  // Legends
  const selected = { manufacturer: new Set(), bodytype: new Set(), engines: new Set(), family: new Set() };
  function applyHighlight() {
    function match(d) {
      const okM = selected.manufacturer.size ? selected.manufacturer.has(d.Manufacturer) : true;
      const okB = selected.bodytype.size ? selected.bodytype.has(d["Body Type"]) : true;
      const okE = selected.engines.size ? selected.engines.has(String(d.Engines)) : true;
      const okF = selected.family.size ? selected.family.has(d.Family) : true;
      return okM && okB && okE && okF;
    }
    dots.attr("opacity", d => match(d) ? 1 : 0.15).attr("stroke-width", d => match(d) ? 3 : 1.5);
    labels.attr("opacity", d => match(d) ? 1 : 0.15);
  }

  function buildLegend(listId, values, formatter, selectSet, makeSwatch) {
    const wrap = d3.select(listId);
    const items = wrap.selectAll("div.legend-item").data(values, d => d).join(enter => enter.append("div").attr("class","legend-item"));
    items.html("");
    items.each(function(d) {
      const row = d3.select(this);
      if (makeSwatch) row.append("span").attr("class","swatch").attr("data-eng", d);
      row.append("span").text(formatter ? formatter(d) : d);
    });
    if (makeSwatch) {
      items.select(".swatch").each(function(d) { const s = d3.select(this); makeSwatch(s, d); });
    }
    items.on("click", function(event, d) {
      const multi = event.shiftKey;
      if (selectSet.has(d)) { if (!multi) { selectSet.clear(); } else { selectSet.delete(d); } }
      else { if (!multi) { selectSet.clear(); } selectSet.add(d); }
      items.classed("active", node => selectSet.has(node));
      applyHighlight();
      event.stopPropagation();
    });
  }

  const manufacturers = Array.from(new Set(data.map(d => d.Manufacturer))).sort();
  const bodytypes = Array.from(new Set(data.map(d => d["Body Type"]))).sort();
  const engines = Array.from(new Set(data.map(d => String(d.Engines)))).sort((a,b)=>+a-+b);
  const families = Array.from(new Set(data.map(d => d.Family))).sort();

  buildLegend("#list-manufacturer", manufacturers, d => d, selected.manufacturer, (sw, d) => { sw.classed("color-airbus", d === "Airbus"); sw.classed("color-boeing", d === "Boeing"); });
  buildLegend("#list-bodytype", bodytypes, d => d, selected.bodytype, (sw, d) => { sw.classed(d === "Wide" ? "solid" : "dashed", true); sw.style("border-color", "#6b7280"); });
  buildLegend("#list-engines", engines, d => d + " engines", selected.engines, (sw, d) => { sw.classed("engines", true).attr("data-eng", d); sw.style("border-color", "#6b7280"); });
  buildLegend("#list-family", families, d => d, selected.family, (sw, d) => { sw.style("border-color", "#6b7280"); });

  d3.select("body").on("click", function(event) {
    const insideLegend = event.target.closest ? event.target.closest(".legend-item") : null;
    if (!insideLegend) { selected.manufacturer.clear(); selected.bodytype.clear(); selected.engines.clear(); selected.family.clear(); d3.selectAll(".legend-item").classed("active", false); applyHighlight(); }
  });

  // Downloads
  document.getElementById("download-svg").onclick = () => {
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svg.node());
    const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "aircraft_chart.svg"; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  };

  document.getElementById("download-png").onclick = () => {
    const serializer = new XMLSerializer();
    const source = serializer.serializeToString(svg.node());
    const svgBlob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement("canvas");
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,width,height);
      ctx.drawImage(img, 0, 0, width, height);
      URL.revokeObjectURL(url);
      canvas.toBlob((blob) => {
        const a = document.createElement("a");
        const pngUrl = URL.createObjectURL(blob);
        a.href = pngUrl; a.download = "aircraft_chart.png";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(pngUrl);
      });
    };
    img.src = url;
  };
}

build();
window.addEventListener("resize", () => { build(); });
</script>
